@Styles.Render("~/Content/sweetAlert")

<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2019.2.514/styles/kendo.common-material.min.css" />
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2019.2.514/styles/kendo.material.min.css" />
<link rel="stylesheet" href="https://kendo.cdn.telerik.com/2019.2.514/styles/kendo.material.mobile.min.css" />
<script src="https://kendo.cdn.telerik.com/2019.2.514/js/jquery.min.js"></script>
<script src="https://kendo.cdn.telerik.com/2019.2.514/js/kendo.all.min.js"></script>
@Scripts.Render("~/Script/sweetAlert")
<style>
    .k-multicheck-wrap {
        overflow-x: auto;
    }
</style>
<div class="modal-dialog modal-lg" role="document" style="width:1450px;">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="PriceModalLabel">Modal title</h5>
            
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="Agentid" value="0" />
            <div id="Resellerpriceexample">
                <div id="Resellerpricegrid"></div>
            </div>
        </div>
        <div class="modal-footer">
            <a onclick="IsResetConfirm()">Reset</a>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
    </div>
</div>

<script>

    function FindDefaultPercentage(ResellerPer, CustomerPer) {

        return (((CustomerPer - ResellerPer) * 100) / CustomerPer);
    }

    function OpenPriceModel(id, name) {
        $("#PriceModalLabel").html("Price List of (" + name + ")");

        $("#Agentid").val(id);

        getData(id);
    }

    function getData(id) {
        var crudServiceBaseUrl = window.location.origin;

        dataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: crudServiceBaseUrl + "/Admin/GetResellerPrice?Id=" + id,
                    dataType: "json",
                },
                update: {
                    url: crudServiceBaseUrl + "/Admin/UpdateResellerPrice?Id=" + id,
                    dataType: "json",
                },
                parameterMap: function (options, operation) {
                    if (operation !== "read" && options.models) {
                        return { models: kendo.stringify(options.models) };
                    }
                }
            },
            batch: true,
            //pageSize: 20,

            schema: {
                model: {
                    id: "Id",
                    fields: {
                        Id: { editable: false, nullable: true },
                        MicrosoftId: { type: "string", editable: false, },
                        Name: { type: "string",editable: false },
                        PurchaseUnit: { type: "string",editable: false },
                        AgreementType: { type: "string", editable: false },
                        CustomerType: { type: "string",editable: false },
                        LicenseType: { type: "string", editable: false },
                        StartDate: { type: "date", editable: false},
                        EndDate: { type: "date", editable: false, },
                        Price: { type: "number", editable: false },
                        ResellerPrice: { type: "number", validation: { required: true, min: 1 } },
                        ResellerPricePercentage: { type: "number", editable: true},
                        CustomerPrice: { type: "number", editable: false, validation: { required: false, min: 1 } },
                        CustomerPricePercentage: { type: "number", editable: false },
                        DefaultMarginReseller: { type: "number", editable: true }

                    }
                }
            },
            change: function (e) {

                if (e.action === "itemchange" && (e.field == "ResellerPrice" || e.field == "ResellerPricePercentage" || e.field == "DefaultMarginReseller")) {

                    var model = e.items[0],
                        Price = model.Price,
                        ResellerPrice = model.ResellerPrice,
                        ResellerPricePercentage = model.ResellerPricePercentage,
                        CustomerPrice = model.CustomerPrice,
                        CustomerPricePercentage = model.CustomerPricePercentage,
                        Id = e.items[0].Id,
                        DefaultMarginReseller = model.DefaultMarginReseller,
                        grid = $("#Resellerpricegrid").data("kendoGrid");
                    var dataItem = grid.dataSource.get(Id);

                    if (e.field == "ResellerPrice") {
                        var per = (((ResellerPrice - Price) * 100) / Price).toFixed(2);
                        dataItem.set("DefaultMarginReseller", FindDefaultPercentage(per, CustomerPricePercentage));
                        dataItem.set("ResellerPricePercentage", per);
                        //e.items[0].set("Account Percentage", FindDefaultPercentage(per, CustomerPricePercentage));
                    }
                    else if (e.field == "ResellerPricePercentage") {
                        var CusValue = (((ResellerPricePercentage * Price) / 100) + Price).toFixed(2);
                        dataItem.set("DefaultMarginReseller", FindDefaultPercentage(ResellerPricePercentage, CustomerPricePercentage));
                        dataItem.set("ResellerPrice", CusValue);
                        // e.items[0].set("Account Percentage", FindDefaultPercentage(ResellerPricePercentage, CustomerPricePercentage));
                    }
                    else if (e.field == "DefaultMarginReseller") {

                        //var resellerPrice = (((ResellerPricePercentage * Price) / 100) + Price).toFixed(2);
                        //dataItem.set("ResellerPrice", resellerPrice);
                        var DefValue = (CustomerPricePercentage - ((DefaultMarginReseller * CustomerPricePercentage) / 100)).toFixed(2);
                        dataItem.set("ResellerPricePercentage", DefValue);
                    }
                }
            }
        });

        $("#Resellerpricegrid").kendoGrid({
            dataSource: dataSource,
            pageable: false,
            height: 400,
            filterable: true,
            sortable: true,
            filterMenuInit: function (e) {
                $(e.container).css("width", "200px")
            },
            columns: [
                //{ command: ["edit"], title: "&nbsp;", width: "150px" },

                //{ field: "ResellerPrice", title: "Reseller Price", format: "{0:c}", width: "150px" },
                //{
                //    field: "ResellerPricePercentage", title: "Reseller Margin %", width: "150px",
                //    template: '#=kendo.format("{0:p}", ResellerPricePercentage/100)#',
                //},
                //{
                //    field: "DefaultMarginReseller", title: "Admin Share", width: "150px",
                //    template: '#=kendo.format("{0:p}", DefaultMarginReseller/100)#',
                //},

                //{ field: "CustomerPrice", title: "ERP Price", format: "{0:c}", width: "150px" },
                //{
                //    field: "CustomerPricePercentage", title: "ERP Profit %", width: "150px",
                //    template: '#=kendo.format("{0:p}", CustomerPricePercentage/100)#',
                //    // template: '#=kendo.format("{0:p}", (((CustomerPrice -ResellerPrice)  * 100) /ResellerPrice)/100)#',
                //},
                //{ field: "Price", title: "Buying Price", format: "{0:c}", width: "150px" },
                //{ field: "Name", title: "Name", width: "300px" },
                //{ field: "PurchaseUnit", title: "Purchase Unit", width: "150px" },

                { field: "StartDate", title: "Valid From", width: "200px", format: "{0:dd/MM/yyyy}", },
                { field: "EndDate", title: "Valid To", width: "200px", format: "{0:dd/MM/yyyy}", },
                { field: "Name", title: "Name", width: "300px", filterable: { multi: true, search: true} },
                { field: "MicrosoftId", title: "Microsoft Id", width: "300px", filterable: { multi: true, search: true, } },
                { field: "AgreementType", title: "Agreement Type", width: "200px", filterable: { multi: true, search: true } },
                { field: "PurchaseUnit", title: "Purchase Unit", width: "150px", filterable: { multi: true, search: true } },
                { field: "LicenseType", title: "License Type", width: "200px", filterable: { multi: true, search: true } },
                { field: "CustomerType", title: "Customer Type", width: "300px", filterable: { multi: true, search: true } },
                { field: "Price", title: "Buying Price", format: "{0:c}", width: "150px", filterable: { multi: true, search: true, }},
                {
                    field: "CustomerPrice", title: "ERP Price", format: "{0:c}", width: "150px", filterable: { multi: true, search: true, } },
                {
                    field: "CustomerPricePercentage", title: "ERP Profit %", width: "150px",
                    template: '#=kendo.format("{0:p}", CustomerPricePercentage/100)#',
                    // template: '#=kendo.format("{0:p}", (((CustomerPrice -ResellerPrice)  * 100) /ResellerPrice)/100)#',
                },
                {
                    field: "DefaultMarginReseller", title: "Profit Share", width: "150px",
                    template: '#=kendo.format("{0:p}", DefaultMarginReseller/100)#',
                },
                { field: "ResellerPrice", title: "Reseller Price", format: "{0:c}", width: "150px", filterable: { multi: true, search: true, } },
                {
                    field: "ResellerPricePercentage", title: "Reseller Profit %", width: "150px",
                    template: '#=kendo.format("{0:p}", ResellerPricePercentage/100)#',
                },
                { command: ["edit"], title: "&nbsp;", width: "150px" },
            ],
            editable: "inline",
        });
    }

    function IsResetConfirm() {
        var Id = $("#Agentid").val();
        swal({
            title: "Are you sure?",
            text: "You want to reset that price list!",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "Yes, reset it!",
            cancelButtonText: "No, cancel plx!",
            closeOnConfirm: false,
            closeOnClickOutside: false,
            closeOnCancel: false
        }, function (isConfirm) {
            if (isConfirm) {
                $.ajax({
                    url: "/Admin/Reset",
                    data: { 'id': Id },
                    success: function (result) {
                        if (result == "Reset") {
                           
                            swal("Reset!", "Successfully price list has been reset.", "success");
                            getData(Id);
                        }
                        else
                            swal("Error", result, "error");

                    }, error: function (xyz) {
                        swal("Error", xyz, "error");
                    }
                });

            } else {
                swal("Cancelled", "Your price list is safe :)", "error");
            }
        });
        return false;
    }
</script>































